<!DOCTYPE html>
<html>
<head>
    <title>Bergara Guessr - PWA</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#e67e22">
    <style>
        /* (Se mantiene tu estilo original) */
        body { margin: 0; font-family: 'Segoe UI', sans-serif; overflow: hidden; background: #000; }
        #street-view { height: 100vh; width: 100vw; position: absolute; z-index: 1; }
        #map-container { position: absolute; bottom: 20px; right: 20px; width: 500px; height: 400px; z-index: 10; transition: all 0.3s ease-in-out; border: 4px solid white; border-radius: 15px; box-shadow: 0 8px 30px rgba(0,0,0,0.5); background: white; overflow: hidden; }
        #map-container.fullscreen { width: 90vw; height: 85vh; bottom: 5vh; right: 5vw; }
        #map { width: 100%; height: 100%; }
        #toggle-map { position: absolute; top: 10px; left: 10px; z-index: 11; background: rgba(255,255,255,0.9); border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        #confirm-btn { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 12; background: #27ae60; color: white; border: none; padding: 12px 24px; border-radius: 30px; cursor: pointer; font-weight: bold; font-size: 18px; display: none; box-shadow: 0 4px 15px rgba(0,0,0,0.3); text-transform: uppercase; }
        #ui { position: absolute; top: 20px; left: 20px; z-index: 20; background: rgba(255, 255, 255, 0.95); padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); min-width: 250px; border-left: 6px solid #e67e22; }
        .main-btn { background: #e67e22; color: white; border: none; padding: 15px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; font-size: 16px; display: block; text-align: center; text-decoration: none; }
    </style>
</head>
<body>
    <div id="street-view"></div>
    <div id="map-container">
        <button id="toggle-map" onclick="toggleMapSize()">⤢ Pantalla Completa</button>
        <div id="map"></div>
        <button id="confirm-btn" onclick="confirmGuess()">Confirmar Ubicación</button>
    </div>
    <div id="ui">
        <div id="round-label" style="font-weight:bold; color:#666;">Ronda 1 / 3</div>
        <div id="timer" style="font-size:22px; color:#dc3545; font-weight:bold;">Tiempo: 0.0s</div>
        <div id="score" style="font-size:28px; font-weight:bold;">Total: 0</div>
        <div id="distance" style="color:#666; font-size:14px; margin-bottom:10px;">Busca el sitio en Bergara</div>
        <button id="action-btn" class="main-btn" onclick="spawnRandomLocation()" style="display:none;">Siguiente Ronda</button>
        <div id="ranking-container"></div>
    </div>

    <script>
        // --- AQUÍ ESTÁ EL ACTIVADOR DEL SERVICE WORKER ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('Service Worker registrado con éxito:', reg.scope))
                    .catch(err => console.log('Error al registrar el Service Worker:', err));
            });
        }

        // (Se mantiene toda tu lógica de juego original de index.html)
        let panorama, map, marker, targetMarker, targetLocation, line;
        let totalScore = 0, currentRound = 1, startTime, timerInterval;
        let totalDistance = 0, totalTime = 0;
        let lastClickedLatLng = null, hasGuessed = false;
        const MAX_ROUNDS = 3;
        const BERGARA_BOUNDS = { north: 43.145, south: 43.080, west: -2.450, east: -2.380 };

        function initGame() {
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 43.117, lng: -2.413 }, zoom: 14, disableDefaultUI: true, mapTypeId: 'roadmap'
            });
            panorama = new google.maps.StreetViewPanorama(document.getElementById("street-view"), {
                addressControl: false, showRoadLabels: false, zoomControl: true
            });
            map.addListener("click", (e) => {
                if (hasGuessed) return;
                lastClickedLatLng = e.latLng;
                if (marker) { marker.setMap(null); } 
                marker = new google.maps.Marker({ position: lastClickedLatLng, map: map, label: "TÚ" });
                document.getElementById("confirm-btn").style.display = "block";
            });
            spawnRandomLocation();
        }

        function toggleMapSize() {
            const container = document.getElementById("map-container");
            const btn = document.getElementById("toggle-map");
            container.classList.toggle("fullscreen");
            btn.innerText = container.classList.contains("fullscreen") ? "⤫ Minimizar" : "⤢ Pantalla Completa";
            google.maps.event.trigger(map, "resize");
        }

        function spawnRandomLocation() {
            if (currentRound > MAX_ROUNDS) { location.reload(); return; }
            if (marker) marker.setMap(null); if (targetMarker) targetMarker.setMap(null); if (line) line.setMap(null);
            marker = null; hasGuessed = false;
            document.getElementById("round-label").innerText = `Ronda ${currentRound} / ${MAX_ROUNDS}`;
            document.getElementById("action-btn").style.display = "none";
            document.getElementById("confirm-btn").style.display = "none";

            const sv = new google.maps.StreetViewService();
            const findLoc = () => {
                const rLat = Math.random() * (BERGARA_BOUNDS.north - BERGARA_BOUNDS.south) + BERGARA_BOUNDS.south;
                const rLng = Math.random() * (BERGARA_BOUNDS.east - BERGARA_BOUNDS.west) + BERGARA_BOUNDS.west;
                sv.getPanorama({ location: {lat: rLat, lng: rLng}, radius: 1000 }, (data, status) => {
                    if (status === "OK") {
                        targetLocation = data.location.latLng;
                        panorama.setPano(data.location.pano);
                        startTime = Date.now();
                        if(timerInterval) clearInterval(timerInterval);
                        timerInterval = setInterval(() => {
                            document.getElementById("timer").innerText = `Tiempo: ${((Date.now() - startTime) / 1000).toFixed(1)}s`;
                        }, 100);
                    } else { findLoc(); }
                });
            };
            findLoc();
        }

        function confirmGuess() {
            hasGuessed = true;
            clearInterval(timerInterval);
            const timeRound = (Date.now() - startTime) / 1000;
            document.getElementById("confirm-btn").style.display = "none";
            if(document.getElementById("map-container").classList.contains("fullscreen")) toggleMapSize();
            
            targetMarker = new google.maps.Marker({ 
                position: targetLocation, map: map, label: "OK", icon: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png'
            });
            line = new google.maps.Polyline({ path: [lastClickedLatLng, targetLocation], strokeColor: "#FF0000", strokeWeight: 3, map: map });

            const dist = google.maps.geometry.spherical.computeDistanceBetween(lastClickedLatLng, targetLocation);
            const pts = Math.round((5000 * Math.exp(-dist / 600)) * Math.max(0.1, 1 - (timeRound / 90)));
            
            totalScore += pts;
            totalDistance += dist;
            totalTime += timeRound;
            
            document.getElementById("score").innerText = `Total: ${totalScore}`;
            document.getElementById("distance").innerText = `+${pts} pts (${dist.toFixed(0)}m en ${timeRound.toFixed(1)}s)`;
            
            const btn = document.getElementById("action-btn");
            btn.style.display = "block";
            
            if (currentRound === MAX_ROUNDS) {
                btn.innerText = "ENVIAR PUNTUACIÓN";
                btn.style.background = "#27ae60";
                btn.onclick = () => {
                    const formID = "1FAIpQLSf8XQVkzDrBxCG-6fivWlgm9d_T26EgsKSZzpBXpsD7vrYaMg";
                    const idPuntos = "1166392297";
                    const idDistancia = "606242080";
                    const idTiempo = "1955371500";
                    
                    const url = `https://docs.google.com/forms/d/e/${formID}/viewform?usp=pp_url` +
                                `&entry.${idPuntos}=${totalScore}` +
                                `&entry.${idDistancia}=${totalDistance.toFixed(0)}` +
                                `&entry.${idTiempo}=${totalTime.toFixed(1)}`;
                    
                    window.open(url, '_blank');
                    mostrarBotonRanking();
                };
            } else { currentRound++; btn.innerText = "Siguiente Ronda"; }
        }

        function mostrarBotonRanking() {
            const container = document.getElementById("ranking-container");
            if (!document.getElementById("rank-btn")) {
                const rBtn = document.createElement("button");
                rBtn.id = "rank-btn";
                rBtn.className = "main-btn";
                rBtn.style.background = "#3498db";
                rBtn.innerText = "VER CLASIFICACIÓN";
                rBtn.onclick = () => {
                    window.open("https://docs.google.com/spreadsheets/d/e/2PACX-1vTZuZdTXwry0KUyxTbgWwtUt29I9FXRWEGwieQP8rH09DYeA3IyppYphMAlise3Vre6I8DUlBjGxp2c/pubhtml?gid=1216099204&single=true", "_blank");
                };
                container.appendChild(rBtn);
            }
        }
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDBqsKR977KyYJ9rRBW8du_Ac9-EW4uZHg&libraries=geometry&callback=initGame"></script>
</body>
</html>